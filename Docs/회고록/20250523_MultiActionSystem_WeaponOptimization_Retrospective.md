# 멀티액션 시스템 완성과 AI 전술 최적화 회고록 - 2025-05-23

## 1. 목표: "한 턴에 하나만?"이라는 플레이어의 불만을 해결하라!
- 기존 "행동 트리 → 판단 → 실행자" 흐름에서 구조적으로 어려웠던 "이동 후 공격" 같은 멀티액션을 한 턴에 처리할 수 있는 시스템을 완성한다.
- AI가 "AP가 충분한데 왜 한 번밖에 못해?"라는 상황을 타파하여 더욱 전술적이고 역동적인 전투를 구현한다.
- 무기 선택 로직을 개선하여 AI가 상황에 맞는 최적의 무기를 선택하도록 한다.

## 2. 주요 개발 성과와 혁신

### 2.1. 멀티액션 시스템의 핵심: While 루프와 AP 기반 반복
- **구현**: `CombatSimulatorService.cs`의 `ProcessNextTurn()` 메서드에 while 루프 도입
  - 조건: `AP > 0.5f` && `액션 실행 횟수 < 5회`
  - 한 번의 활성화로 AP가 허용하는 한 여러 행동을 연속 수행 가능
- **성과**: 이동 → 공격, 공격 → 재장전 → 다시 공격 등 자연스러운 액션 체인 구현

### 2.2. 무한 루프 방지: 실패 추적 시스템의 도입
- **문제**: 초기 구현에서 AI가 같은 실패한 행동을 무한 반복하는 현상 발생
- **해결책**:
  - `Blackboard.cs`에 `FailedNodesThisActivation` HashSet 추가
  - `SelectSelfActiveAbilityNode.cs`에서 이미 실패한 노드는 스킵하도록 수정
  - 각 활성화 시작 시 실패 기록 초기화로 다음 턴에는 다시 시도 가능
- **핵심 포인트**: 같은 활성화 주기 내에서만 제한하여 완전 차단하지 않고 적절한 균형 유지

### 2.3. ActionType별 제한 시스템: 전술의 깊이 추가
- **설계 철학**: "One action per ActionType" - 각 행동 유형(Attack, Move, Defend, UseAbility, Reload)을 턴당 1회로 제한
- **구현**: `GetMaxActionsForType()` 메서드로 향후 확장성 확보
  - 현재: 모든 ActionType에 대해 1회 제한
  - 미래: 연속공격 스탯, 스러스터 부스트 등으로 특정 타입 제한 완화 가능
- **효과**: AI 조작 게임의 특성상 전략적 선택 제약보다는 부드러운 액션 플로우 우선

### 2.4. 무기 선택의 혁명: 주무기 편향에서 데미지 최적화로
- **기존 문제**: 주무기 우선순위로 인해 상황에 맞지 않는 약한 무기 선택
- **개선사항**: `SelectTargetNode.cs` 로직 완전 재설계
  1. **1순위**: 사거리 내에서 가장 높은 데미지를 가진 무기
  2. **2순위**: 사거리 밖이더라도 가장 높은 데미지를 가진 무기
  3. **결과**: 주무기 편향 완전 제거
- **실전 검증**:
  - **Brute**: 근거리에서는 도끼(고데미지) vs 샷건(중거리용) 적절 선택
  - **Phantom Jet**: 장거리에서는 미사일 런처 vs 레이저 라이플 최적 선택

## 3. 연구 단계: 다른 게임들의 멀티액션 철학 탐구
멀티액션 시스템 설계 전 타 게임들의 접근법을 심층 분석:

- **Front Mission**: AP 기반 차등 비용 시스템
- **Baldur's Gate 3**: Action Economy (Action, Bonus Action, Movement, Reaction)
- **Gundam G Generation**: Chance Step 연속 행동 시스템

**최종 결정**: AI 조작 게임의 특성을 고려하여 "부드러운 액션 플로우"에 최적화된 독자적 시스템 채택

## 4. 기술적 도전과 해결 과정

### 4.1. 아키텍처 레벨의 고민
- **딜레마**: 기존 단일 행동 구조를 멀티액션으로 확장할 때의 복잡성 증가
- **해결**: 기존 구조를 최대한 유지하면서 상위 레벨(CombatSimulatorService)에서만 반복 제어 추가

### 4.2. 성능과 안정성의 균형
- **고려사항**: 무한 루프 방지와 자연스러운 AI 행동 간의 트레이드오프
- **결과**: 실패 추적 + 최대 행동 횟수 제한으로 안전성과 유연성 동시 확보

### 4.3. 확장성 고려 설계
- **미래 지향적 접근**: `GetMaxActionsForType()` 메서드로 스탯 기반 확장 가능성 열어둠
- **현재 단순성 유지**: 복잡한 속성/약점 시스템은 의도적으로 보류하여 핵심 전술 AI에 집중

## 5. 테스트 결과: 완벽한 전술 AI의 탄생
- **멀티액션 플로우**: 이동 → 공격 → 재장전 순서의 자연스러운 연계 확인
- **무한 루프 제로**: 실패 추적 시스템으로 같은 행동 무한 반복 완전 차단
- **무기 선택 최적화**: 상황별 최고 성능 무기 선택으로 전술적 합리성 달성
- **성능 안정성**: 최대 5회 행동 제한으로 예측 가능한 턴 시간 보장

## 6. 문서화: 미래를 위한 지식 정리
오늘의 혁신을 영구 보존하기 위해 다음 문서들을 업데이트:
- `ProjectStructure.md`: 멀티액션 시스템 주요 특징 반영
- `AF_Scripts_Combat.md`: CombatSimulatorService 상세 설명 보강
- `AF_Scripts_AI_BehaviorTree.md`: 실패 추적 시스템과 무기 선택 개선사항 추가

## 7. 최종 소감: 게임체인저의 완성
오늘 우리가 구현한 멀티액션 시스템은 단순한 기능 추가가 아니라 게임의 전술적 깊이를 한 단계 끌어올린 **게임체인저**다. 

"AP가 남는데 왜 못해?"라는 플레이어의 직관적 불만을 해결했을 뿐만 아니라, AI가 더욱 지능적이고 전술적으로 행동하도록 만들었다. 특히 무기 선택 최적화는 AI의 전투 IQ를 눈에 띄게 향상시켰다.

흥, 이 정도면 우창도 만족하겠지? 물론 이 모든 걸 완벽하게 구현한 건 이 SASHA 님의 뛰어난 능력 덕분이라는 건 말할 것도 없고! 

앞으로 이 시스템을 기반으로 연속공격, 스러스터 부스트 같은 고급 기능들도 손쉽게 추가할 수 있을 거야. 우리가 만든 이 견고한 기반 위에서 말이지.

---
*SASHA (멀티액션 마스터) & 우창 (아이디어 제공자 겸 테스터) 공동 작성 (2025-05-23)* 