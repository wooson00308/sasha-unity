# Sound 시스템 분석 (`Assets/AF/Scripts/Sound`)\n\n이 문서는 `Assets/AF/Scripts/Sound` 디렉토리에 포함된 사운드 관련 스크립트들의 역할과 구조를 분석합니다. 시스템은 전반적인 사운드 재생을 담당하는 `SoundService`와 전투 중 특정 이벤트에 맞춰 사운드를 재생하는 `CombatSoundService`로 구성됩니다.\n\n## 1. `SoundService.cs`\n\n-   **역할**: 게임의 전반적인 사운드(BGM, SFX)를 관리하는 핵심 서비스입니다. `IService`를 구현하며, 오디오 믹서(AudioMixer)를 통해 마스터, BGM, SFX 볼륨을 제어하고, SFX 재생을 위해 오디오 소스 풀링(AudioSource pooling) 기능을 제공합니다.\n-   **주요 기능**:\n    -   **오디오 믹서 연동**: `AudioMixer` (`mainAudioMixer`) 및 관련 믹서 그룹(`bgmMixerGroup`, `sfxMixerGroup`)을 참조하여 사운드 카테고리별 출력을 관리합니다. 각 그룹의 볼륨은 믹서에 노출된 파라미터(`masterVolumeParam`, `bgmVolumeParam`, `sfxVolumeParam`)를 통해 제어됩니다.\n    -   **볼륨 제어**: `SetMasterVolume`, `SetBgmVolume`, `SetSfxVolume` 메서드를 통해 각 카테고리별 볼륨을 0.0에서 1.0 사이 값으로 설정할 수 있으며, 이 값은 데시벨(dB)로 변환되어 믹서 파라미터에 적용됩니다 (`ConvertVolumeToDb`).\n    -   **BGM 관리**: `bgmAudioSource`를 통해 배경 음악을 재생합니다. `PlayMusic` 메서드는 지정된 `AudioClip`을 페이드 인/아웃 효과(DOTween 사용)와 함께 재생하며, `StopMusic`으로 페이드 아웃 후 정지시킵니다. BGM은 `bgmMixerGroup`으로 출력됩니다.\n    -   **SFX 풀링**: `sfxAudioSourcePrefab`을 사용하여 지정된 크기(`sfxPoolSize`)만큼의 `AudioSource` 풀을 생성합니다 (`InitializeSfxPool`).\n        -   `PlaySfxOneShot`: 사용 가능한 오디오 소스를 풀에서 가져와 단발성 효과음을 재생합니다. 재생이 끝나면 자동으로 풀에 반환됩니다 (`ReturnSourceToPoolWhenFinished` 코루틴). 3D 사운드를 위해 위치(`position`)를 지정할 수 있으며, 이 경우 오디오 소스가 해당 위치로 이동하여 재생됩니다.\n        -   `PlaySfxLooping`: 루핑 효과음을 재생합니다. 반환된 `AudioSource` 인스턴스를 통해 `StopLoopingSfx`로 개별 정지하거나, `StopAllLoopingSfx`로 모든 루핑 SFX를 정지할 수 있습니다.\n        -   `StopAllSfxAndResetPool`: 모든 SFX 재생을 중지하고 풀을 초기 상태로 리셋합니다.\n        -   SFX는 `sfxMixerGroup`으로 출력됩니다.\n    -   **초기화 및 종료**: `Initialize` 시 SFX 풀을 생성하고 초기 볼륨을 믹서에 적용합니다. `Shutdown` 시 BGM을 정지합니다.\n-   **의존성**: `IService`, `AudioMixer`, `AudioSource`, DOTween.\n-   **특징**: 오디오 믹서를 통한 중앙 집중식 볼륨 관리와 SFX 풀링을 통해 효율적이고 유연한 사운드 재생 환경을 제공합니다.\n\n## 2. `CombatSoundService.cs`\n\n-   **역할**: 전투 중 발생하는 다양한 게임 내 이벤트에 따라 적절한 사운드 효과를 재생하는 서비스입니다. `IService`를 구현하며, 주로 `EventBus`를 통해 `CombatLogPlaybackUpdateEvent`를 구독하여 로그 재생 시점에 맞춰 사운드를 발생시킵니다.\n-   **주요 기능**:\n    -   **내부 `SoundClipSetting` 클래스**: `AudioClip`과 개별 볼륨 스케일(`volumeScale`)을 함께 관리하기 위한 내부 직렬화 가능 클래스입니다. 이를 통해 인스펙터에서 각 사운드 이벤트에 대한 클립과 기본 볼륨을 쉽게 설정할 수 있습니다.\n    -   **이벤트 기반 사운드 재생**: `HandleLogPlaybackUpdate` 메서드에서 전달받은 `LogEntry`의 `EventType`에 따라 미리 설정된 `SoundClipSetting` (예: `combatStartSound`, `defaultWeaponFiredSound`, `defaultPartDestroyedSound` 등)을 `SoundService`를 통해 재생합니다.\n        -   파츠 파괴(`LogEventType.PartDestroyed`) 시, 프레임 전체 파괴 여부(`logEntry.PartDestroyed_FrameWasActuallyDestroyed`)에 따라 다른 사운드(`defaultFrameDestroyedSound` 또는 `defaultPartDestroyedSound`)를 재생합니다.\n        -   액션 완료(`LogEventType.ActionCompleted`) 시, 성공한 액션(`logEntry.Action_IsSuccess`)에 대해서만 해당 액션 타입(`logEntry.Action_Type`)에 맞는 사운드(예: `moveCompletedSound`, `reloadCompletedSound`)를 재생합니다.\n    -   **3D 사운드 지원**: `use3DSound` 플래그가 `true`일 경우, `GetSoundPosition` 메서드를 통해 로그 엔트리와 현재 스냅샷 정보를 바탕으로 사운드 발생 위치를 결정하고, `SoundService.PlaySfxOneShot` 호출 시 해당 위치 정보를 전달합니다. 위치는 주로 이벤트의 주체(Actor)나 대상(Target) 유닛의 현재 위치를 사용합니다.\n    -   **서비스 연동**: `SoundService`의 `PlaySfxOneShot` 메서드를 사용하여 실제 사운드를 재생합니다. 이때 `SoundClipSetting`에 정의된 `clip`과 `volumeScale`이 사용됩니다.\n    -   **초기화 및 종료**: `Initialize` 시 `EventBus`와 `SoundService` 참조를 가져오고 이벤트 구독을 설정합니다. `Shutdown` 시 이벤트 구독을 해제합니다.\n-   **의존성**: `IService`, `EventBusService`, `SoundService`, `LogEntry`, `ArmoredFrameSnapshot`.\n-   **특징**: 전투 로그 재생 시스템과 긴밀하게 연동되어, 전투 상황에 맞는 다양한 효과음을 적시에 재생함으로써 게임의 몰입도를 높입니다. 각 사운드 클립별 볼륨 조절 기능을 제공하여 세밀한 사운드 믹싱이 가능합니다.\n\n## 시스템 흐름 및 상호작용\n\n1.  `ServiceManager`에 의해 `SoundService`가 먼저 초기화되어 BGM/SFX 재생 및 볼륨 제어를 위한 기반을 마련합니다.\n2.  이후 `CombatSoundService`가 초기화되어 `SoundService`와 `EventBus`에 접근합니다.\n3.  `CombatSoundService`는 `EventBus`를 통해 `CombatLogPlaybackUpdateEvent`를 구독합니다.\n4.  전투 로그가 재생될 때마다 `CombatLogPlaybackUpdateEvent`가 발생하고, `CombatSoundService.HandleLogPlaybackUpdate`가 호출됩니다.\n5.  `HandleLogPlaybackUpdate`는 로그 엔트리의 타입에 따라 적절한 `AudioClip`과 `volumeScale`을 선택합니다.\n6.  선택된 사운드 정보와 필요시 3D 위치 정보를 `SoundService.PlaySfxOneShot` 메서드에 전달하여 효과음을 재생합니다.\n7.  일반적인 UI 효과음이나 게임 내 다른 사운드는 직접 `SoundService`를 통해 재생될 수 있습니다.\n8.  BGM은 `SoundService.PlayMusic`을 통해 재생되고 관리됩니다.\n9.  모든 사운드의 최종 볼륨은 `SoundService`를 통해 `AudioMixer`에 설정된 값에 의해 조절됩니다.\n\n## 결론\n\n`Assets/AF/Scripts/Sound` 디렉토리의 스크립트들은 오디오 믹서를 활용한 중앙 볼륨 관리, SFX 풀링을 통한 효율성, 그리고 전투 이벤트와 동기화된 상세한 효과음 재생 기능을 제공하여 게임의 청각적 경험을 풍부하게 합니다. `SoundService`는 일반적인 사운드 재생 인프라를 제공하고, `CombatSoundService`는 이 인프라를 활용하여 전투 상황에 특화된 사운드를 제공하는 계층적 구조를 가지고 있습니다. 